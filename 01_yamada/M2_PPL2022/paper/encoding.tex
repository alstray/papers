\section{配電網問題のASP符号化}\label{chap:encode}

本節では，配電網問題の入力と制約を論理プログラムとして表現する方
法について述べる．

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[float=tb,caption={%
  配電網問題(図~\ref{fig:test-input})のファクト表現},%
captionpos=b,frame=single,label=code:test.lp,%
xrightmargin=1zw,% 
xleftmargin=1zw,% 
numbersep=5pt,%
numbers=none,%
breaklines=true,%
columns=fullflexible,keepspaces=true,%
basicstyle=\ttfamily\scriptsize]{code/test.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\vskip 3em
要相談

\textbf{ASPファクト形式.} 
配電網問題の入力(図~\ref{fig:test-input})のファクト表現を
コード\ref{code:test.lp}に示す．
この問題は，区間25個，スイッチ16個から構成されている．
各区間とスイッチは，隣接関係をアトム\code{dnet_node/2}によって表される．
例えば，ファクト\code{dnet_node(1,2).}は，ノード\code{1}とノード\code{2}が
隣接していることを表す．

\vskip 3em

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\textbf{前処理.}
配電網問題を解くための前処理となるASP符号化をコード\ref{code:prepro.lp}に示す．
1行目のルールは，スイッチを含むノード(スイッチノード)番号を表すアトム\code{swt_node(X)}
を導入する．この\code{swt_node(X)}は，ノード番号\code{X}はスイッチを含むことを意味する．
反対に，2行目のルールは，スイッチを含まないノード(ジャンクションノード)番号を表すアトム
\code{jct_node(X)}を導入する．この\code{jct_node(X)}は，ノード\code{X}には，
スイッチが含まれないことを意味する．

4行目のルールは，各区間がどのノード番号に属するかを表す
アトム\code{section(S,X)}を導入する．
また，5行目で区間を意味するアトム\code{section(S)}を導入する．

7,8行目のルールでは，各区間について，スイッチノードまたはジャンクションノードに
含まれていることを表すアトム\code{swt_node(S)},\code{jct_node(S)}を導入する．

10行目のルールで，各スイッチがどの2つの区間を接続されているかを表すアトム
\code{switch(SW,S,T)}を導入する．このアトム\code{switch(SW,S,T)}は，
区間\code{(S,T)}はスイッチ\code{SW}で接続されていることを意味する．

14行目からのルールは根付き全域森問題の入力を生成するルールである．
14,15行目のルールは，根付き全域森問題のノードと区間を対応させるアトム\code{node/2}を導入する．
アトム\code{node(X,S)}は，各区間\code{S}は根付き全域森のノード\code{X}に含まれることを意味する．
14行目のルールで，ジャンクションノードはそのまま根付き全域森のノードとして定義され，ジャンクション
ノードに属する区間は，そのまま対応づけられる．
15行目のルールでは，スイッチノードに含まれ，ジャンクションノードに含まれない各区間について，
属するノード番号のうち，小さい方の番号を根付き全域森問題のノードとして定義する．

18行目は，根ノードを表すアトム\code{root(X)}を導入する．この\code{root(X)}は，\code{node(X,S)}
のうち，区間\code{S}が変電所と直接つながっているならば，根ノードであることを意味する．また，
19行目で各\code{node/2}を，根付き全域森問題の入力のノードを表すアトム\code{node/1}とする．
20行目で，辺を表すアトム\code{edge(X,Y)}を導入する．この\code{edge(X,Y)}は任意の2つの
ノード\code{(X,Y)}が辺で結ばれていることを意味する．


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[float=tb,caption={%
  根付き全域森問題の基本符号化},%
captionpos=b,frame=single,label=code:srf1.lp,%
xrightmargin=1zw,% 
xleftmargin=1zw,% 
numbersep=5pt,%
numbers=left,%
breaklines=true,%
columns=fullflexible,keepspaces=true,%
basicstyle=\ttfamily\scriptsize]{code/srf1.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[float=tb,caption={%
  根付き全域森問題の改良符号化},%
captionpos=b,frame=single,label=code:srf2.lp,%
xrightmargin=1zw,% 
xleftmargin=1zw,% 
numbersep=5pt,%
numbers=left,%
breaklines=true,%
columns=fullflexible,keepspaces=true,%
basicstyle=\ttfamily\scriptsize]{code/srf2.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[float=tb,caption={%
  根付き全域森問題の発展符号化},%
captionpos=b,frame=single,label=code:srf3.lp,%
xrightmargin=1zw,% 
xleftmargin=1zw,% 
numbersep=5pt,%
numbers=left,%
breaklines=true,%
columns=fullflexible,keepspaces=true,%
basicstyle=\ttfamily\scriptsize]{code/srf3.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{根付き全域森問題のASP符号化}
\textbf{基本符号化.}
根付き全域森問題のASP符号化をコード\ref{code:srf1.lp}に示す．
2行目のルールは，各辺(\code{X},\code{Y})に対して，
解の候補となるアトム\code{inForest(X,Y)}を導入する．
この\code{inForest(X,Y)}は，
辺(\code{X},\code{Y})が根付き全域森に含まれることを意味する．
%
各ノードの到達可能性は5～7行目のルールで表される．
アトム\code{reached(X,R)}は，ノード\code{X}は根
\code{R}から到達可能であることを意味する．
5行目のルールは，各根ノードは自分自身から到達可能であることを表す．
6～7行目のルールは，ノード\code{Y}が根ノード\code{R}から到達可能であり，
かつ，辺(\code{X},\code{Y})が全域森に含まれるならば，
ノード\code{X}も\code{R}から到達可能であることを表す．

非閉路制約は10～13行目のルールで表される．
このルールは，各連結成分のノード数と辺数の差が1になること(木の性質)を，
ASP の重み付き個数制約を使って表している．
%
根付き連結制約は16～17行目のルールで表される．
16行目のルールは，各ノードは少なくとも1つの根から到達可能であることを
表している(\textit{at-least-one}制約)．
17行目のルールは，各ノードは高々1つの根から到達可能である
ことを表している(\textit{at-most-one}制約)．
これら2つの一貫性制約により，各ノードはちょうど1つの根から到達可能であ
ることが強制される．

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\textbf{改良符号化.}
基本符号化は，根付き全域森問題の制約をASPのルール7個で簡潔に表現できる．
しかし，根付き連結制約を表す\textit{at-most-one}制約の基礎化後のルール
数は，根ノード数の2乗に比例するため，大規模な問題に対する求解性能が低
下する可能性がある．
%
この問題を解決するために考案した改良符号化をコード\ref{code:srf2.lp}に
示す．基本符号化との違いは，根付き連結制約をASPの個数制約で表している
点である(16行目)．
グラフのノード数を$n$，根ノード数を$r$として，
根付き連結制約の基礎化後のルール数を比較すると，
基本符号化が$n(1+{}_{r}C_{2})$個なのに対し，
改良符号化は$n$個と少なく抑えることができる．
これにより，大規模な問題に対する有効性が期待できる．
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\textbf{発展符号化．}
非閉路制約を別の方法で符号化するために，根付き全域森問題を有向グラフに拡張し，
各ノードの入次数に関する制約を用いて符号化を行った．考案した発展符号化を
コード\ref{code:srf3.lp}に示す．
9行目のルールでは，各根ノードについて，入次数は0であることを強制している．
10行目のルールでは，根ノード以外の各ノードについて，入次数が1であることを保証している．
その他のルールは改良符号化と同じである．

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{電流制約のASP符号化}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[float=tb,caption={%
  電流制約の符号化},%
captionpos=b,frame=single,label=code:electrical.lp,%
xrightmargin=1zw,% 
xleftmargin=1zw,% 
numbersep=5pt,%
numbers=left,%
breaklines=true,%
columns=fullflexible,keepspaces=true,%
basicstyle=\ttfamily\scriptsize]{code/electrical.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

電流制約のASP符号化をコード\ref{code:electrical.lp}に示す．
3行目のルールで，根付き全域森問題の解となるアトム\code{inForest(X,Y)}をもとに，
配電網において，スイッチが閉じて区間が接続されていることを表すアトム\code{connected(SW,S,T)}を
導入する．このアトムは，区間\code{S}からスイッチ\code{SW}によって，
もう1つの区間\code{T}に接続していることを表す．
6行目のルールで，配電網問題の解を表すアトム\code{closed_switch(SW)}を導入する．
この\code{closed_switch(SW)}は，スイッチ\code{SW}が閉じたスイッチであることを意味する．

ジャンクションノード内での上下流の関係は，8,9行目のルールで表される．
アトム\code{entrance_section(S,X)}は，区間\code{S}がノード\code{X}内で
最も上流にあることを意味する．8行目のルールで変電所と直接つながっている区間が上流にあることを
表している．9行目のルールで，ジャンクションノード内の区間が，スイッチによって外部のノードから
接続されているならば上流であることを意味している．

また供給経路内の上下関係は，アトム\code{downstream(S,T)}で
表される．この\code{downstream(S,T)}は，区間\code{S}の下流に区間\code{T}が接続されている
ことを意味する．12行目のルールで，接続されている2つの区間\code{(S,T)}がそのまま上下関係である
ことを意味している．13行目のルールでは，\code{entrance_section(S,X)}が属するノード\code{X}内
にある他の区間\code{T}が下流にあることを意味している．

15,16行目は，変電所と区間の供給関係を表している．アトム\code{suppliable(T,R)}は，
区間\code{T}が変電所\code{R}から供給を受けていることを意味する．
15行目のルールでは，各変電所は自身から供給を受けることを表す．16行目のルールでは，
区間\code{S}が変電所\code{R}から供給され，かつ，区間\code{T}が\code{S}の下流にある
ならば，\code{T}も\code{R}から供給されることを表す．

18行目のルールで，各変電所\code{R}について，供給する各区間\code{S}の負荷\code{I}の総和が
入力として与えられる\code{max_current}以下でなければならないことを表す．

%%% Local Variables:
%%% mode: japanese-latex
%%% TeX-master: "paper"
%%% End:
