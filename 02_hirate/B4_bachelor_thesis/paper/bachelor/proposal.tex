%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{解集合プログラミングを用いたハミルトン路・閉路問題のASP符号化}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
本章では，ASPを用いた第\ref{sec:background}章にて説明した諸問題を解く流れと提案する符号化について説明する．
まずは，本研究でASPシステム \clingo を用いて諸問題を解いた流れを図\ref{aspmethod}に図示したので，
これについて解説する．
はじめに２つのファイルを作成した．
図における''問題''にあたるグラフを，ASPシステムが読み取れるように，ASPファクト形式で記述したものと，
諸問題をASP符号化したものである．
これらをASPシステムに処理させることで，解集合が出力される．
この解集合が諸問題の解，つまりは条件を満たしたハミルトン路・閉路を表している．

以下，本章ではASPファクト形式でのグラフの表現と，提案するASP符号化手法について説明する．
\input{fig/asp_method}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{ASPファクト形式}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[tbp]
\begin{center}
\input{fig/graph_example}
\caption{グラフの例}
\label{graphexample}
\end{center}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
前述のように，問題をASPシステムに解かせるには，グラフをASPファクト形式にて記述する必要があった．
以下では，図\ref{graphexample}を例として，解説する．
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[caption =  図\ref{graphexample}のASPファクト表現,label = graphexamplp]{code/graph_example.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
コード\ref{graphexamplp}は，ASPファクト形式で図\ref{graphexample}のグラフを表現したものである．
アトム\code{node}は各頂点を表し，\code{edge}は各辺を表す．
よって，コード\ref{graphexamplp}の２行目は，頂点が番号１〜６の６つあることを定義し，
５〜７行目では，辺が7つ定義されている．
アトム\code{edge}は２つ引数を持ち，これは表す辺の両端の頂点番号である．
例えば\code{edge(1,2)}は\code{node(1)}と\code{node(2)}を結ぶ無向辺を表す．
最後に，１０〜１２行目にあるアトム\code{cost}について，図\ref{graphexample}では表記されていないが，これは各辺に割り当てられる重みの値を表す．\code{cost(X,Y,C)}は\code{edge(X,Y}の重みがCであることを定義する．
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{ハミルトン路・閉路問題のASP符号化}\label{hamiltonianasp}
本研究では，\textbf{undirected}，\textbf{directed}，\textbf{acyclicity}の３通りのASP符号化を提案する．
これらはいずれもハミルトン路・閉路問題のASP符号化である．

無向グラフ$G=(V,E)$上にハミルトン閉路が存在する必要十分条件は，
以下の２つの制約を満たす部分グラフ$G'=(V,E')$が存在することである．\\
\begin{itemize}
\item $G'$の各頂点の次数が2 \ (次数の制約)\\
\item $G'$が連結である \ (連結の制約)\\
\end{itemize}
本論文では，前者を\textbf{次数の制約}，後者を\textbf{連結の制約}と呼ぶ．
ハミルトン閉路問題のASP符号化は，この２つの制約をASP言語のルールで記述することにほとんど等しい．
ただし，ハミルトン路問題では，次数の制約は以下のように変わる．\\
\begin{itemize}
\item ハミルトン路の始点と終点の次数が１，他の頂点の次数が2\\
\end{itemize}

\subsection{undirected}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[caption =  ASP符号化 undirected,label = undirected]{code/hamilton1.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

符号化undirectedはコード\ref{undirected}である．
次数の制約は，３〜８行目に記したように実装し，
連結の制約は，１０〜１３行目が対応している．
１行目のルールでは，選択子を用いて
「各辺はハミルトン路・閉路に含まれるか，含まれないかのどちらかである」
という制約を実装した．
つまり，アトム\code{in(X,Y)}が解集合に含まれれば，
\code{X}と\code{Y}を両端とする辺が，解となるハミルトン路・閉路に含まれるということである．

次に次数の制約について，ボディに\code{s == t}が含まれる３〜４行目がハミルトン閉路問題に適用されるルールであり，
\code{s != t}が含まれる５〜８行目がハミルトン路問題に適用されるルールである．
なお，変数\code{s}と\code{t}はそれぞれハミルトン路の始点と終点であり，
このように，ハミルトン路問題を解くのか，ハミルトン閉路問題を解くのかの区別にも使われる．
３〜４行目は「各頂点\code{X}について，その次数が２以上２以下である」という制約を，
５〜６行目は「始点\code{s}と終点\code{t}を除く各頂点Xの次数が２以上２以下である」という制約を，
７行目は「始点\code{s}の次数が１以上１以下である」という制約を，
８行目は「終点\code{t}の次数が１以上１以下である」という制約をそれぞれ表している．

続いて，連結の制約については１０〜１３行目で表現した．
連結の制約は，
「全ての頂点が解となるハミルトン路・閉路を辿ることで始点から到達可能でなければならない」
という制約として実装した．
その実装にあたり，新たに導入したアトム\code{reached(X)}が，
「頂点\code{X}が，解となるハミルトン路・閉路を辿ることで始点\code{s}から到達可能である」という意味を示すように，
１０〜１２行目のルールを記述した．
まず，始点\code{s}が到達可能でなければならないため，
１０行目のファクトを記述した．
１１，１２行目は，どちらも「頂点\code{X}が到達可能であり，頂点\code{X}と\code{Y}を両端とする辺が解となるハミルトン路・閉路に含まれるならば，頂点\code{Y}も到達可能である．」というルールである．
最後に１３行目のルールで「全ての頂点\code{X}が，解となるハミルトン路・閉路を辿ることで始点から到達可能でなければならない」という連結の制約を実装した．
\newpage
符号化directedとacyclicityでは，
与えられた無向グラフを有向グラフ化し，
その有向グラフ上でハミルトン路・閉路を探索する．
\subsection{directed}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[caption =  ASP符号化 directed,label = directed]{code/hamilton2.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
無向グラフ$G$を有向グラフ$G'$として扱うには，
$G$上の全ての無向辺\code{edge(X,Y)}について
有向辺\code{edge(X,Y)}，\code{edge(Y,X)}を用意すれば良い．
そのため，コード\ref{directed}の１行目のルールで与えられた無向グラフの有向グラフ化を行った．
２行目は，符号化undirectedと同様，
「各辺はハミルトン路・閉路に含まれるか，含まれないかのどちらかである」
というルールである．

次に次数の制約についてだが，有向グラフ上での次数の制約は無向グラフ上のものとはやや異なる．
ハミルトン路・閉路問題における次数の制約は，有向グラフ$G'$上で，それぞれ以下のようになる．
\begin{itemize}
\item $G'$の頂点の内，ハミルトン路の始点の出次数が１で入次数が０，終点の出次数が０で入次数が１であり，その他の出次数と入次数がそれぞれ１である．
\item $G'$の各頂点の出次数と入次数がそれぞれ１である．
\end{itemize}
コード\code{directed}で次数の制約は，ハミルトン閉路問題に対して４〜５行目で，
ハミルトン路問題に対しては６〜１３行目に記述した．
４行目は「各頂点\code{X}の出次数が１である」，
５行目は「各頂点\code{X}の入次数が１である」というルールである．
６，７行目は「始点\code{s}と終点\code{t}以外の各頂点\code{X}の入次数が１である」，
８，９行目は「始点\code{s}と終点\code{t}以外の各頂点\code{X}の出次数が１である」．
１０行目は「始点\code{s}の入次数が１である」ことを，
１１行目は「始点\code{s}の出次数が０である」ことを，
１２行目は「終点\code{t}の出次数が１である」ことを，
１３行目は「終点\code{t}の入次数が０である」ことをそれぞれ示す．

１５〜１７行目は連結の制約についての記述である．
これについては符号化undirectedと同様の実装法である．

２０行目は，対称性除去のためのルールである．
例えば，頂点が３つの無向グラフに$1 - 2 - 3 - 1$
というハミルトン閉路が存在した時に，これを有向グラフ化すると，
$1 \rightarrow 2 \rightarrow 3 \rightarrow 1$，
$1 \rightarrow 3 \rightarrow 2 \rightarrow 1$の２通りのハミルトン閉路としてカウントされてしまう．
これを修正するために，始点から出る有向辺が入る頂点の番号\code{X}が，
終点に入る有向辺が出る頂点番号\code{Y}よりも小さいという制約を加えた．
\newpage
\subsection{acyclicity}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[caption =  ASP符号化 acyclicity,label = acyclicity]{code/hamilton3.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
符号化acyclicityもdirected同様，無向グラフを有向グラフ化し，そのグラフ上でハミルトン路・閉路を探索する．
１〜１３，１８〜１９行目はdirectedと何も変わらない．異なるのは１５，１６行目の連結の制約のみである．

１５，１６行目は連結の制約を表していない．
そもそも，これまでの二つの符号化において，次数の制約だけではなく連結の制約が必要とされたのは，
始点と終点を含まない閉路の存在を禁止するためである．
符号化acyclicityでは，閉路の禁止として非循環性を保証するために，clingoの組み込みディレクティブ\code{#edge}\cite{gebser2016}
を使用した．この場合，組み込みのアサイクリシティチェック\cite{bomanson2016}が使用される．\cite{dimopoulos2018}
１５行目では，ハミルトン路問題に対して「解となるハミルトン路上の辺で閉路が構成されることはない」という制約を，
１６行目では，ハミルトン閉路問題に対して「解となるハミルトン閉路上の辺で始点と終点を含まない閉路が構成されることはない」という制約をそれぞれ表している．
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{最短ハミルトン路・閉路問題のASP符号化}\label{minexpl}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[caption =  最適化,label = minimize]{code/obj_minimize.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ref{sec:background}章で説明したように，
ハミルトン路・閉路を構成する各辺の重みの総和が
最短ハミルトン路・閉路問題の目的関数である．
よって，\ref{hamiltonianasp}にて説明した各符号化により
求められたハミルトン路・閉路のうち，
目的関数値が最小であるものが問題の解となる．
その最小化の処理を行うのがコード\ref{minimize}である．

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[caption =  重み付き無向グラフの有向グラフ化,label = costboth]{code/cost_both.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
さらに，無向グラフの有向グラフ化を行った
符号化directed，acyclicityについては，
アトム\code{cost}についても有向グラフ化に
対応させるためにコード\ref{costboth}を追加した．

このように，\ref{hamiltonianasp}にて説明した３符号化について，
符号化undirectedにコード\ref{minimize}を，
符号化directedにコード\ref{minimize}とコード\ref{costboth}を，
符号化acyclicityにコード\ref{minimize}とコード\ref{costboth}をそれぞれ追加した．
最短ハミルトン路・閉路問題を対象とする時，
符号化undirected，符号化directed，符号化acyclicityは，
これらコードを追加後のものを指すこととする．
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{コスト制約付きハミルトン路問題のASP符号化}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstinputlisting[caption = コスト制約, label = costconst]{code/cost_constraint.lp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ref{hamiltonianasp}にて説明した各符号化に，
コード\ref{costconst}を追加した．
コード\ref{costconst}は，\ref{sec:background}章で説明したように，
ハミルトン路を構成する辺の重みの総和を\code{c}以下とする制約を表す．
以後，この\code{c}の値を制約コスト値と呼ぶ．

また，\ref{minexpl}同様に，
符号化directed，acyclicityについては，
アトム\code{cost}についても有向グラフ化に
対応させるためにコード\ref{costboth}を追加した．

なお，コスト制約付きハミルトン路・閉路問題を対象とする時，
符号化undirected，符号化directed，符号化acyclicityは，
これらコードを追加後のものを指すこととする．
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "paper"
%%% End:
